# 调试技术

内核空间的调试比用户空间要艰难许多，并且风险级别更高，一个小错误就有可能引起系统崩溃。驾驭内核调试的能力，需要整个操作系统有深入的理解。

## 通过打印来调试

`printk()`函数几乎可以在任何场景下使用，并且可以根据日志的等级在终端上打印消息。

可供使用的日志等级有：

| 日志等级 | 描述
| ----- | ----- |
| KERN_EMERG | 紧急情况 |
| KERN_ALERT | 需要立即采取行动 |
| KERN_CRIT | 临界状态，通常涉及严重的硬件或软件操作失败 |
| KERN_ERR | 报告错误状态，设备驱动程序常用 |
| KERN_WARNING | 警告 |
| KERN_NOTICE | 提示信息 |
| KERN_INFO | 记录信息 |
| KERN_DEBUG | 调试信息 |

变量console_loglevel的初始值是DEFAULT_CONSOLE_LOGLEVEL，只有优先级小于这个值的等级，才能被打印出来。

用户空间守护进程klogd从记录缓冲区中获取内核消息，然后由syslogd守护进程保存至系统日志文件中。如果klogd没有运行，那么消息就无法传递到用户空间，只能通过`dmesg`命令查看。

内核使用{==循环缓冲区==}来记录消息，如果缓冲区内容已满，`printk`就绕回开始处填写新的数据，这将覆盖陈旧的内容

## 内核oops

oops是内核告知用户有故障发生的最常用的方式，oops的产生有多种原因，比如内存访问越界或者非法指令等。内核发出oops时处于极不稳定状态，有可能会崩溃。

## 内核调试配置选项

在编译内核时，内核在Kernel hacking菜单项中提供了许多配置选项，它们都依赖于CONFIG_DEBUG_KERNEL。开发内核时，可以打开这些选项进行调试。