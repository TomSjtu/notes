# GIC

由于现在的Soc做得越来越复杂，中断的管理越来越困难，所以ARM公司专门开发了GIC，用于统一管理中断。目前最新版本是GIC-V4。

每一个中断支持的状态有以下4种：

- 不活跃状态：中断处于无效状态
- 等待状态：中断处于有效状态，但是CPU还未响应
- 活跃状态：CPU已经响应中断
- 活跃并等待状态：CPU正在响应，但是该中断源又发送了一个中断

外设中断支持两种触发方式：

- 边沿触发：当中断源产生一个上升沿或者下降沿时，触发一个中断
- 电平触发：当中断源产生一个高电平或者低电平时，触发一个中断

GIC支持三种类型的中断：

SGI（Software Generated Interrupt）：软件产生的中断，可以用于多核间的通信，一个CPU可以通过写GIC的寄存器给另外一个CPU产生中断。

PPI（Private Peripheral Interrupt）：某个CPU私有外设的中断，只能发给绑定的那个CPU。

SPI（Shared Peripheral Interrupt）：共享外设的中断，可以发送给任何一个CPU。

ARM Linux的中断默认在CPU0上产生。

要使用GIC中断，必须指定是以上类型中的哪一个中断。

## GIC-V2

GIC-V2由两个硬件单元组成，一个是{==分发器==}：用来做中断的仲裁和分发；一个是{==CPU接口==}：用来与CPU核心连接。分发器只有一个，是公用的，但是每个CPU核心都有一个CPU接口，它们通过nIRQ和nFIQ引脚连接。

## 中断流程

GIC检测中断的流程如下：

1. 当GIC检测到一个中断时，标记该中断为等待状态
2. 对于等待状态的中断，分发器会确定目标CPU，将中断请求发送给这个CPU
3. 对于每个CPU，分发器会从众多处于等待状态的中断中选择一个优先级最高的中断，发送给CPU接口
4. CPU接口会决定这个中断是否可以发送给CPU，如果可以，GIC就会发送一个中断请求信号给CPU
5. CPU进入中断异常，由Linux内核的中断处理器程序来读取寄存器中的中断源信息，同时GIC会做以下处理：、

    - 如果该中断处于等待状态，那么状态将变成活跃
    - 如果该中断又重新产生，那么状态将变成活跃并等待
    - 如果该中断处于活跃状态，那么状态将变成活跃并等待

6. 处理器完成中断服务，发送一个完成信号给GIC

GIC支持中断优先级抢占，即便一个中断已经发生。

## GIC寄存器

GIC寄存器用于配置和控制中断的行为，由分发器的寄存器和CPU接口的寄存器组成。
